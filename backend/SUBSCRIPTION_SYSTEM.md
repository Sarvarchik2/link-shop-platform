# Система управления подписками

## Обзор

Полностью функциональная система управления подписками для платформы магазинов.

## Основные возможности

### Для владельцев магазинов:
1. **Просмотр доступных тарифных планов** (`GET /subscription-plans`)
   - Отображение всех активных планов подписки
   - Информация о цене, функциях и ограничениях каждого плана

2. **Отправка запроса на подписку** (`POST /shop/{shop_slug}/subscription/request`)
   - Выбор тарифного плана
   - Выбор длительности (1, 3, 6, 12 месяцев)
   - Автоматические скидки при выборе длительных периодов
   - Защита от дублирования запросов (один активный запрос на магазин)

3. **Проверка статуса запроса** (`GET /shop/{shop_slug}/subscription/request`)
   - Просмотр текущего запроса на подписку
   - Статусы: pending (на рассмотрении), approved (одобрено), rejected (отклонено)

### Для платформенного администратора:
1. **Просмотр всех запросов** (`GET /platform/admin/subscription-requests`)
   - Фильтрация по статусу (pending, approved, rejected)
   - Информация о магазине, выбранном плане и длительности

2. **Одобрение/Отклонение запросов** (`PUT /platform/admin/subscription-requests/{request_id}`)
   - При одобрении:
     - Автоматическое обновление статуса подписки магазина на "active"
     - Автоматический расчет даты истечения (текущая дата + длительность в месяцах)
     - Магазин получает доступ ко всем функциям платформы
   - При отклонении:
     - Возможность добавить комментарий с причиной отклонения
     - Владелец магазина может отправить новый запрос

## Workflow (Процесс работы)

```
1. Владелец магазина отправляет запрос на подписку
   ↓
2. Запрос попадает в список ожидания (status: pending)
   ↓
3. Администратор платформы просматривает запрос
   ↓
4. Администратор одобряет или отклоняет запрос
   ↓
5а. При одобрении:
    - subscription_status → "active"
    - subscription_expires_at → текущая_дата + (duration_months * 30 дней)
    - Магазин активирован
   ↓
5б. При отклонении:
    - Владелец получает уведомление
    - Может отправить новый запрос
```

## API Endpoints

### Публичные (для владельцев магазинов):
- `GET /subscription-plans` - Список доступных планов
- `POST /shop/{shop_slug}/subscription/request` - Создать запрос
- `GET /shop/{shop_slug}/subscription/request` - Проверить статус

### Административные (только для platform_admin):
- `GET /platform/admin/subscription-requests?status={status}` - Список всех запросов
- `PUT /platform/admin/subscription-requests/{request_id}` - Одобрить/Отклонить

## Модели данных

### SubscriptionPlan
```python
{
    "id": int,
    "name": str,              # Название плана
    "slug": str,              # Уникальный идентификатор
    "price": float,           # Цена за месяц
    "period_days": int,       # Период (обычно 30)
    "description": str,       # Описание
    "features": str,          # Список функций (через запятую)
    "is_trial": bool,         # Пробный период?
    "is_active": bool,        # Активен?
    "max_products": int       # Лимит товаров
}
```

### SubscriptionRequest
```python
{
    "id": int,
    "shop_id": int,
    "plan_id": int,
    "duration_months": int,   # 1, 3, 6, или 12
    "status": str,            # pending, approved, rejected
    "requested_at": datetime,
    "approved_at": datetime,  # Когда одобрено/отклонено
    "notes": str              # Комментарии администратора
}
```

## Автоматическая инициализация

При первом запуске бэкенда автоматически создаются:

### Тарифные планы:
1. **Пробный период** (trial)
   - Цена: $0
   - Длительность: 30 дней
   - До 50 товаров

2. **Базовый** (basic)
   - Цена: $29/месяц
   - До 200 товаров
   - Приоритетная поддержка

3. **Премиум** (premium)
   - Цена: $79/месяц
   - Безлимитные товары
   - Личный менеджер

### Специальные предложения:
1. Индивидуальный дизайн (от $199)
2. Приоритетное размещение ($49/мес)

## Фронтенд страницы

### Для владельцев магазинов:
- `/shop/{slug}/subscription` - Просмотр и выбор планов

### Для администратора:
- `/platform/admin/subscription-requests` - Управление запросами
- `/platform/admin/shops` - Управление магазинами (включая подписки)

## Безопасность

- Все эндпоинты защищены JWT аутентификацией
- Владелец магазина может управлять только своими запросами
- Административные функции доступны только platform_admin
- Проверка прав доступа на уровне сервиса

## Примеры использования

### Отправка запроса на подписку (владелец магазина):
```javascript
const response = await $fetch('/shop/my-shop/subscription/request', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${token}` },
  body: {
    plan_id: 2,           // Базовый план
    duration_months: 3    // 3 месяца
  }
})
```

### Одобрение запроса (администратор):
```javascript
const response = await $fetch('/platform/admin/subscription-requests/123', {
  method: 'PUT',
  headers: { 'Authorization': `Bearer ${token}` },
  body: {
    status: 'approved',
    notes: 'Оплата получена, подписка активирована'
  }
})
```

## Расчет скидок

Скидки применяются автоматически при выборе длительных периодов:
- 1 месяц: 0% скидка
- 3 месяца: 5% скидка
- 6 месяцев: 10% скидка
- 12 месяцев: 15% скидка

Пример: План за $29/мес на 12 месяцев:
- Без скидки: $29 × 12 = $348
- Со скидкой 15%: $348 - $52.20 = $295.80
- Экономия: $52.20
